<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE sqlMap      
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"      
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">
    
<sqlMap namespace="creditoscae.procedimientosAlmacenados">
        
     <!--  Inserta estado cabecera nomina-->
	 <parameterMap id="setEstadoNomina" class="java.util.HashMap">
       <parameter property="cno_id"              jdbcType="INTEGER" javaType="java.lang.Integer"/>
       <parameter property="cod_id_estado"       jdbcType="CHAR"    javaType="java.lang.String"/>
	   <parameter property="eno_glosa"          jdbcType="VARCHAR"    javaType="java.lang.String"/>
    </parameterMap>
    
    <procedure id="insertaEstadoNomina" parameterMap="setEstadoNomina" resultClass="int">
     { call sp_ins_estado_nomina(?,?,?) }
    </procedure>
	
    <!--  Obtiene item nomina por rut   -->
	<parameterMap id="setItemNominaPorRut" class="java.util.HashMap">
      	<parameter property="ino_rut"            jdbcType="NUMERIC"      javaType="java.lang.Long"/>
		<parameter property="ino_dv"             jdbcType="CHAR"         javaType="java.lang.String"/>
    </parameterMap>
	
	<resultMap id="getItemNominaPorRut" class="java.util.HashMap"> 
          <result property="nombres"                    column="ino_nombres"                         javaType="java.lang.String"  />
		  <result property="apellidoPaterno"            column="ino_apellido_paterno"                javaType="java.lang.String"  />
		  <result property="apellidoMaterno"            column="ino_apellido_materno"                javaType="java.lang.String"  />
		  <result property="rut"                        column="ino_rut"                             javaType="java.lang.Long"    />
		  <result property="dv"                         column="ino_dv"                              javaType="java.lang.String"  />
    </resultMap>    
	
	<procedure id="buscarItemNominaPorRut" parameterMap="setItemNominaPorRut" resultMap="getItemNominaPorRut">
        { call sp_cns_item_nomina_cae_por_rut ( ?,? ) }
    </procedure>
		
		
	 <!--  Elimina item de una nÃ³mina por rut (Eliminacion logica)-->
	 <parameterMap id="setItemPorRut"                        class="java.util.HashMap">
            <parameter property="ino_rut"                         jdbcType="NUMERIC"    javaType="java.lang.Long"/>
			<parameter property="ino_dv"                          jdbcType="CHAR"       javaType="java.lang.String"/>
    </parameterMap>
    
    <procedure id="eliminarItemPorRut" parameterMap="setItemPorRut" resultClass="int">
     { call sp_del_item_nomina_cae_por_rut(?,?) }
    </procedure>	
		
    <!--  Obtiene nominas autorizadas   -->		
	<parameterMap id="setObtenerNominasAutorizadas" class="java.util.HashMap">
        <parameter property="idTipoNominaCae"             jdbcType="CHAR"         javaType="java.lang.String"/>
		<parameter property="nombreArchivo"               jdbcType="CHAR"         javaType="java.lang.String"/>
		<parameter property="idPlantilla"                 jdbcType="INTEGER"      javaType="java.lang.Integer"/>
		<parameter property="folio"                       jdbcType="INTEGER"      javaType="java.lang.Integer"/>
		<parameter property="idEstadoNominaCae"           jdbcType="CHAR"         javaType="java.lang.String"/>
	</parameterMap>
	
	<resultMap id="getNominasAutorizadas" class="java.util.HashMap"> 
          <result property="idPlantilla"                    column="cpl_id"                          javaType="java.lang.Integer" />
		  <result property="idNomina"                       column="cno_id"                          javaType="java.lang.Integer" />
		  <result property="nombreArchivo"                  column="arc_nombre"                      javaType="java.lang.String"  />
		  <result property="separador"                      column="cpl_separador"                   javaType="java.lang.String"  />
		  <result property="tasaIntereses"                  column="cno_tasa_interes"                javaType="java.lang.Double"  />
		  <result property="tasaSeguro"                     column="cno_tasa_seguro"                 javaType="java.lang.Double"  />
		  <result property="tipoOperacion"                  column="cno_tipo_operacion"              javaType="java.lang.String"  />
		  <result property="moneda"                         column="cno_moneda"                      javaType="java.lang.String"  />
		  <result property="oficina"                        column="cno_oficina"                     javaType="java.lang.String"  />
		  <result property="canal"                          column="cno_canal"                       javaType="java.lang.String"  />
		  <result property="condicionGarantia"              column="cno_condicion_garantia"          javaType="java.lang.String"  />
		  <result property="destinoCredito"                 column="cno_destino_credito"             javaType="java.lang.String"  />
		  <result property="seguroDesgravamen"              column="cno_seguro_desgravamen"          javaType="java.lang.String"  />
		  <result property="ejecutivo"                      column="cno_ejecutivo"                   javaType="java.lang.String"  />
		  <result property="fechaCurse"                     column="cno_fecha_curse"                 javaType="java.lang.String"   />
          <result property="fechaPrimerVencimiento"         column="cno_fecha_primer_vencimiento"    javaType="java.lang.String"  />
		  <result property="estadoNomina"                   column="cod_id_estado"                   javaType="java.lang.String"  />
		  <result property="glosa"                          column="cno_glosa"                       javaType="java.lang.String"  />
          <result property="fechaEstado"                    column="eno_fecha_estado"                javaType="java.lang.String"  /> 
		  <result property="plazo"                          column="cno_plazo"                       javaType="java.lang.Integer"  />
		  <result property="impuesto"                       column="cno_impuesto"                    javaType="java.lang.Double"  />
          <result property="fechaPago"                      column="cno_fecha_pago"                  javaType="java.util.Date"  /> 
		  <result property="montoNomina"                    column="cno_monto_nomina"                javaType="java.lang.Double"  />
		  <result property="oficio"                         column="cno_oficio"                      javaType="java.lang.String"  />
          <result property="fechaRecepcion"                 column="cno_fecha_recepcion_fondo"       javaType="java.lang.String"  />
		  <result property="fechaRetencion"                 column="cno_fecha_retencion"             javaType="java.lang.String"  /> 
		  <result property="tipoArchivo"                    column="cod_id_tipo_archivo"             javaType="java.lang.String"  /> 
	
          <result property="tasaMuerte"                     column="cno_tasa_muerte"                 javaType="java.lang.Double"  />    <!-- NEW   -->
          <result property="tasaInvalidez"                  column="cno_tasa_invalidez"              javaType="java.lang.Double"  />    <!-- NEW   -->

	</resultMap>    
	
	<procedure id="obtenerNominasParaAutorizar" parameterMap="setObtenerNominasAutorizadas" resultMap="getNominasAutorizadas">
        { call sp_cns_cabecera_nomina_cae ( ?,?,?,?,?) }
    </procedure>
	
	<!-- consulta plantillas  -->
    <parameterMap id="setTipoPlantilla" class="java.util.HashMap">
        <parameter property="tipoPlantilla"      jdbcType="CHAR"      javaType="java.lang.String" />
        <parameter property="codEstado"          jdbcType="CHAR"      javaType="java.lang.String" />
    </parameterMap>
    <resultMap id="getPlantillas" class="java.util.HashMap">
        <result property="idPlantilla"          column="cpl_id"                   javaType="java.lang.Integer" />
        <result property="idEstadoPlantilla"    column="cod_id_estado_plantilla"  javaType="java.lang.String"  />
        <result property="idTipoPlantilla"      column="cod_id_tipo_plantilla"    javaType="java.lang.String"  />
        <result property="nombre"               column="cpl_nombre"               javaType="java.lang.String"  />
        <result property="fechaCreacion"        column="cpl_fecha_creacion"       javaType="java.util.Date"    />
        <result property="separador"            column="cpl_separador"            javaType="java.lang.String"  />
    </resultMap>    
    <procedure id="consultarPlantillas" parameterMap="setTipoPlantilla" resultMap="getPlantillas">
        { CALL sp_cns_cabecera_plantilla_cae ( ?, ? ) }
    </procedure>

    <!-- inserta carga nomina  -->
    <parameterMap id="setInsertarNomina" class="java.util.HashMap">
        <parameter property="cpl_id"                        jdbcType="INTEGER"     javaType="Integer" />  
        <parameter property="cno_id"                        jdbcType="INTEGER"     javaType="Integer" />  
        <parameter property="cno_tasa_interes"              jdbcType="VARCHAR"     javaType="String" />   
        <parameter property="cno_tasa_seguro"               jdbcType="VARCHAR"     javaType="String" />   
        <parameter property="cno_moneda"                    jdbcType="CHAR"        javaType="String" />   
        <parameter property="cno_oficina"                   jdbcType="VARCHAR"     javaType="String" />   
        <parameter property="cno_canal"                     jdbcType="VARCHAR"     javaType="String" />   
        <parameter property="cno_condicion_garantia"        jdbcType="VARCHAR"     javaType="String" />   
        <parameter property="cno_destino_credito"           jdbcType="VARCHAR"     javaType="String" />   
        <parameter property="cno_seguro_desgravamen"        jdbcType="VARCHAR"     javaType="String" />   
        <parameter property="cno_ejecutivo"                 jdbcType="VARCHAR"     javaType="String" />   
        <parameter property="cno_glosa"                     jdbcType="VARCHAR"     javaType="String" />   
        <parameter property="cno_fecha_primer_vencimiento"  jdbcType="DATE"        javaType="Date" />     
        <parameter property="cno_fecha_creacion"            jdbcType="VARCHAR"     javaType="Date"      />     
        <parameter property="cno_fecha_curse"               jdbcType="DATE"        javaType="Date" />     
        <parameter property="cno_plazo"                     jdbcType="VARCHAR"     javaType="String" />  
        <parameter property="cno_impuesto"                  jdbcType="VARCHAR"     javaType="String" />   
        <parameter property="cno_tipo_operacion"            jdbcType="VARCHAR"     javaType="String" />   
        <parameter property="cno_fecha_pago"                jdbcType="DATE"        javaType="Date" />     
        <parameter property="cno_monto_nomina"              jdbcType="VARCHAR"     javaType="String" />   
        <parameter property="cno_oficio"                    jdbcType="VARCHAR"     javaType="String" />   
        <parameter property="cno_fecha_recepcion_fondo"     jdbcType="DATE"        javaType="Date" />     
        <parameter property="cno_fecha_retencion"           jdbcType="DATE"        javaType="Date" />     
        <parameter property="arc_nombre"                    jdbcType="VARCHAR"     javaType="String" />   
        <parameter property="arc_tipo_archivo"              jdbcType="CHAR"        javaType="String" />   
        <parameter property="cod_id_estado"                 jdbcType="CHAR"        javaType="String" />   

        <parameter property="cno_tasa_muerte"               jdbcType="VARCHAR"     javaType="String" />
        <parameter property="cno_tasa_invalidez"            jdbcType="VARCHAR"     javaType="String" />
    </parameterMap>
    <resultMap id="getInsertarNomina" class="java.util.HashMap">  
        <result property="folio"   column="cno_id"     javaType="Integer" />    
    </resultMap>    
    <procedure id="insertarNomina" parameterMap="setInsertarNomina" resultMap="getInsertarNomina">
        { CALL sp_ins_carga_nomina_cae (                    
            #cpl_id#,                                                                                                                                                                                               
            #cno_id#,                                                                                                                                                                                 
            <isNotNull property="cno_tasa_interes"            >#cno_tasa_interes#</isNotNull><isNull property="cno_tasa_interes"                    >NULL</isNull>,                                                                  
            <isNotNull property="cno_tasa_seguro"             >#cno_tasa_seguro#</isNotNull><isNull property="cno_tasa_seguro"                      >NULL</isNull>,                                            
            <isNotNull property="cno_moneda"                  >#cno_moneda#</isNotNull><isNull property="cno_moneda"                                >NULL</isNull>,                                                 
            <isNotNull property="cno_oficina"                 >#cno_oficina#</isNotNull><isNull property="cno_oficina"                              >NULL</isNull>,                                                
            <isNotNull property="cno_canal"                   >#cno_canal#</isNotNull><isNull property="cno_canal"                                  >NULL</isNull>,                                                  
            <isNotNull property="cno_condicion_garantia"      >#cno_condicion_garantia#</isNotNull><isNull property="cno_condicion_garantia"        >NULL</isNull>,                                     
            <isNotNull property="cno_destino_credito"         >#cno_destino_credito#</isNotNull><isNull property="cno_destino_credito"              >NULL</isNull>,                                        
            <isNotNull property="cno_seguro_desgravamen"      >#cno_seguro_desgravamen#</isNotNull><isNull property="cno_seguro_desgravamen"        >NULL</isNull>,                                     
            <isNotNull property="cno_ejecutivo"               >#cno_ejecutivo#</isNotNull><isNull property="cno_ejecutivo"                          >NULL</isNull>,                                              
            <isNotNull property="cno_glosa"                   >#cno_glosa#</isNotNull><isNull property="cno_glosa"                                  >NULL</isNull>,                                                  
            <isNotNull property="cno_fecha_primer_vencimiento">#cno_fecha_primer_vencimiento#</isNotNull><isNull property="cno_fecha_primer_vencimiento">NULL</isNull>,                               
            #cno_fecha_creacion#,                                                                                                                                                                     
            <isNotNull property="cno_fecha_curse"             >#cno_fecha_curse#</isNotNull><isNull property="cno_fecha_curse"                      >NULL</isNull>,                                            
            <isNotNull property="cno_plazo"                   >#cno_plazo#</isNotNull><isNull property="cno_plazo"                                  >NULL</isNull>,                                                  
            <isNotNull property="cno_impuesto"                >#cno_impuesto#</isNotNull><isNull property="cno_impuesto"                            >NULL</isNull>,                                               
            <isNotNull property="cno_tipo_operacion"          >#cno_tipo_operacion#</isNotNull><isNull property="cno_tipo_operacion"                >NULL</isNull>,                                         
            <isNotNull property="cno_fecha_pago"              >#cno_fecha_pago#</isNotNull><isNull property="cno_fecha_pago"                        >NULL</isNull>,                                                              
            <isNotNull property="cno_monto_nomina"            >#cno_monto_nomina#</isNotNull><isNull property="cno_monto_nomina"                    >NULL</isNull>,                                           
            <isNotNull property="cno_oficio"                  >#cno_oficio#</isNotNull><isNull property="cno_oficio"                                >NULL</isNull>,                                                 
            <isNotNull property="cno_fecha_recepcion_fondo"   >#cno_fecha_recepcion_fondo#</isNotNull><isNull property="cno_fecha_recepcion_fondo"  >NULL</isNull>,                                  
            <isNotNull property="cno_fecha_retencion"         >#cno_fecha_retencion#</isNotNull><isNull property="cno_fecha_retencion"              >NULL</isNull>,                                        
            #arc_nombre#,                                                                                                                                                                             
            #arc_tipo_archivo#,                                                                                                                                                                       
            #cod_id_estado#,
            <isNotNull property="cno_tasa_muerte"             >#cno_tasa_muerte#</isNotNull><isNull property="cno_tasa_muerte"                      >NULL</isNull>,
            <isNotNull property="cno_tasa_invalidez"          >#cno_tasa_invalidez#</isNotNull><isNull property="cno_tasa_invalidez"                >NULL</isNull>
            ) }
    </procedure>                                                                                                                                                                                      
                                                                                                                                                                                                         
    <!-- consulta existencia de archivo nomina en proceso  -->
    <parameterMap id="setExisteArchivoNomina" class="java.util.HashMap">
        <parameter property="nombreArchivo"     jdbcType="CHAR"         javaType="java.lang.String" />
        <parameter property="codTipoNomina"     jdbcType="CHAR"         javaType="java.lang.String" />
        <parameter property="fechaCargaIni"     jdbcType="DATETIME"     javaType="java.util.Date" />
        <parameter property="fechaCargaFin"     jdbcType="DATETIME"     javaType="java.util.Date" />
        <parameter property="codEstado"         jdbcType="CHAR"         javaType="java.lang.String" />
    </parameterMap>
    <resultMap id="getExisteArchivoNomina" class="java.util.HashMap">
        <result property="resultado"   column="cno_id"     javaType="Integer" />    
    </resultMap>    
    <procedure id="existeArchivoNomina" parameterMap="setExisteArchivoNomina" resultMap="getExisteArchivoNomina">
        { CALL sp_cns_existeArchivoNominaCae ( ?, ?, ?, ?, ? ) }
    </procedure>


     <!-- consulta nomina procesada -->
    <parameterMap id="setParametrosConsulta" class="java.util.HashMap">
        <parameter property="cno_id"            jdbcType="INTEGER"     javaType="java.lang.Integer" />  
        <parameter property="cno_oficio"        jdbcType="CHAR"        javaType="java.lang.String" />   
        <parameter property="arc_fecha_carga"   jdbcType="CHAR"        javaType="java.lang.String"   />     
        <parameter property="cod_id_estado"     jdbcType="CHAR"        javaType="java.lang.String" />   
        <parameter property="arc_tipo_archivo"  jdbcType="CHAR"        javaType="java.lang.String" />           
    </parameterMap>
    <resultMap id="getConsultaNominaProcesada" class="java.util.HashMap">  
        <result property="nomina"        column="cno_id"            javaType="java.lang.Integer" />    
        <result property="oficio"        column="cno_oficio"        javaType="java.lang.String" />    
        <result property="nombreArchivo" column="arc_nombre"        javaType="java.lang.String" />    
        <result property="fechaCarga"    column="arc_fecha_carga"   javaType="java.util.Date" />            
    </resultMap>    
    <procedure id="consultaNominaProcesada" parameterMap="setParametrosConsulta" resultMap="getConsultaNominaProcesada">
        { CALL sp_cns_nomina_procesada (                    
            <isNotNull property="cno_id"          >#cno_id#</isNotNull><isNull property="cno_id"                    >NULL</isNull>,                                                                  
            <isNotNull property="cno_oficio"      >#cno_oficio#</isNotNull><isNull property="cno_oficio"            >NULL</isNull>,                                                                  
            <isNotNull property="arc_fecha_carga" >#arc_fecha_carga#</isNotNull><isNull property="arc_fecha_carga"  >NULL</isNull>,                                            
            <isNotNull property="cod_id_estado"   >#cod_id_estado#</isNotNull><isNull property="cod_id_estado"      >NULL</isNull>,                                  
            <isNotNull property="arc_tipo_archivo">#arc_tipo_archivo#</isNotNull><isNull property="arc_tipo_archivo">NULL</isNull>                                        
            ) 
        }                                                                                                                                                                       
    </procedure>        
   
   <!-- consulta existencia de archivo nomina en proceso  -->
	
	 <parameterMap id="setListadoInformes" class="java.util.HashMap">
       <parameter property="nombreArchivo"                     jdbcType="VARCHAR"        javaType="java.lang.String"/>
	   <parameter property="fechaCargaIni"                     jdbcType="DATETIME"       javaType="java.util.Date"/>
	   <parameter property="fechaCargaFin"                     jdbcType="DATETIME"       javaType="java.util.Date"/>
	   <parameter property="opcion"                            jdbcType="INTEGER"        javaType="java.lang.Integer"/>
    </parameterMap>
   
    <resultMap id="getListadoInformes" class="java.util.HashMap">
	    <result property="cno_id"                  column="cno_id"                  javaType="java.lang.Integer" />    
	    <result property="arc_nombre"              column="arc_nombre"              javaType="java.lang.String" />    
		<result property="cod_id_tipo_archivo"     column="cod_id_tipo_archivo"     javaType="java.lang.String" />    
		<result property="arc_fecha_carga"         column="arc_fecha_carga"         javaType="java.util.Date" />    
	</resultMap>    
    <procedure id="obtenerListadosArchivos"  parameterMap="setListadoInformes" resultMap="getListadoInformes">
        { CALL sp_cns_informes_nomina ( ?,?,?,?) }
    </procedure>
	
    
	 <!--  Inserta cabecera plantilla -->
	 <parameterMap id="setEncabezadoPlantilla" class="java.util.HashMap">
       <parameter property="cod_id_estado_plantilla"              jdbcType="CHAR"       javaType="java.lang.String"/>
       <parameter property="cod_id_tipo_plantilla"                jdbcType="CHAR"       javaType="java.lang.String"/>
	   <parameter property="cpl_nombre"                           jdbcType="VARCHAR"    javaType="java.lang.String"/>
	   <parameter property="cpl_separador"                        jdbcType="CHAR"       javaType="java.lang.String"/>
    </parameterMap>
    
    <procedure id="crearEncabecadoPlantilla" parameterMap="setEncabezadoPlantilla" resultClass="int">
     { call sp_ins_plantilla_cae(?,?,?,?) }
    </procedure>
	
	 <!--  Inserta item de la plantilla -->
	 <parameterMap id="setEncabezadoPlantilla" class="java.util.HashMap">
       <parameter property="cpl_id"                                      jdbcType="INTEGER"       javaType="java.lang.Integer"/>
       <parameter property="ipl_id"                                      jdbcType="INTEGER"       javaType="java.lang.Integer"/>
	   <parameter property="ipl_nombre"                                  jdbcType="VARCHAR"       javaType="java.lang.String"/>
	   <parameter property="ipl_posicion"                                jdbcType="INTEGER"       javaType="java.lang.Integer"/>
	   <parameter property="ipl_requerido"                               jdbcType="INTEGER"       javaType="java.lang.Integer"/>
	   <parameter property="ipl_tipo"                                    jdbcType="CHAR"          javaType="java.lang.String"/>
    </parameterMap>
    
    <procedure id="crearItemPlantilla" parameterMap="setEncabezadoPlantilla" resultClass="int">
     { call sp_ins_item_plantilla_cae(?,?,?,?,?,?) }
    </procedure>
	
	
	<!-- consulta plantillas  -->
  
    <resultMap id="getPlantillasObtenidas" class="java.util.HashMap">
        <result property="idPlantilla"          column="cpl_id"                   javaType="java.lang.Integer" />
        <result property="idEstadoPlantilla"    column="cod_id_estado_plantilla"  javaType="java.lang.String"  />
        <result property="idTipoPlantilla"      column="cod_id_tipo_plantilla"    javaType="java.lang.String"  />
        <result property="nombre"               column="cpl_nombre"               javaType="java.lang.String"  />
        <result property="fechaCreacion"        column="cpl_fecha_creacion"       javaType="java.util.Date"    />
        <result property="separador"            column="cpl_separador"            javaType="java.lang.String"  />
    </resultMap>    
    <procedure id="obtenerPlantillas"  resultMap="getPlantillasObtenidas">
        { CALL sp_cns_plantilla_obtenida_cae () }
    </procedure>
	
	
	<!-- Consulta items de plantilla -->
	
	 <parameterMap id="setItemsNominasBuscados" class="java.util.HashMap">
       <parameter property="cpl_id"                          jdbcType="INTEGER"       javaType="java.lang.Integer"/>
    </parameterMap>
   
    <resultMap id="getItemsNominasBuscados" class="java.util.HashMap">
	    <result property="ipl_nombre"                column="ipl_nombre"              javaType="java.lang.String" />    
	    <result property="ipl_posicion"              column="ipl_posicion"            javaType="java.lang.Integer" />    
		<result property="ipl_requerido"             column="ipl_requerido"           javaType="java.lang.Integer" />    
		<result property="ipl_tipo"                  column="ipl_tipo"                javaType="java.lang.String" />    
	</resultMap>     
    <procedure id="obtenerItemsPlantillas"  parameterMap="setItemsNominasBuscados" resultMap="getItemsNominasBuscados">
        { CALL sp_cns_items_cae_plantilla (?) }
    </procedure>
	
	<!-- Limpia items de plantilla -->
	
	<parameterMap id="setItemsLimpiar" class="java.util.HashMap">
       <parameter property="cpl_id"                          jdbcType="INTEGER"       javaType="java.lang.Integer"/>
    </parameterMap>
         
    <procedure id="limpiaItemsPlantilla"  parameterMap="setItemsLimpiar" resultClass="int">
        { CALL sp_del_items_plantilla_cae (?) }
    </procedure>
	
	<!-- Elimina plantilla -->
	
	<parameterMap id="setPlantillaEliminar" class="java.util.HashMap">
       <parameter property="cpl_id"                          jdbcType="INTEGER"       javaType="java.lang.Integer"/>
    </parameterMap>
         
    <procedure id="eliminarCabeceraPlantilla"  parameterMap="setPlantillaEliminar" resultClass="int">
        { CALL sp_del_cabecera_plantilla_cae (?) }
    </procedure>
	
	<!-- Descargar archivo -->
	
	 <resultMap id="getArchivoDescarga" class="java.util.HashMap">
	    <result property="arc_contenido"             column="arc_contenido"          javaType="java.lang.Object" />    
	 </resultMap>  
	
	<parameterMap id="setDescargarArchivo" class="java.util.HashMap">
       <parameter property="cno_id"                          jdbcType="INTEGER"       javaType="java.lang.Integer"/>
	   <parameter property="cod_tipo_archivo"                jdbcType="CHAR"          javaType="java.lang.String" />
    </parameterMap>
	
	<procedure id="descargarArchivo"  parameterMap="setDescargarArchivo" resultMap="getArchivoDescarga">
        { CALL sp_des_archivo_nominas_cae (?,?) }
    </procedure>
	
	<!--  Obtiene nominas estados   -->		
	<parameterMap id="setObtenerNominasEstados" class="java.util.HashMap">
       	<parameter property="idEstadoNominaCae"           jdbcType="CHAR"         javaType="java.lang.String"/>
	</parameterMap>
	
	
	<resultMap id="getNominasEstados" class="java.util.HashMap"> 
		  <result property="idPlantilla"                    column="cpl_id"                          javaType="java.lang.Integer" />
		  <result property="idNomina"                       column="cno_id"                          javaType="java.lang.Integer" />
		  <result property="estadoNomina"                   column="cod_id_estado"                   javaType="java.lang.String"  />
		  <result property="fechaEstado"                    column="eno_fecha_estado"                javaType="java.lang.String"  /> 
		  <result property="glosa"                          column="eno_glosa"                       javaType="java.lang.String"  />
		 
     </resultMap>    
	
	<procedure id="obtenerNominasEstados" parameterMap="setObtenerNominasEstados" resultMap="getNominasEstados">
        { call sp_cns_estados_nomina_cae (?) }
    </procedure>
	
	<!-- Obtiene nominas archivo -->
	<parameterMap id="setObtenerArchivosNominas" class="java.util.HashMap">
       	<parameter property="idNomina"                    jdbcType="INTEGER"         javaType="java.lang.Integer"/>
	</parameterMap>
	
	
	<resultMap id="getArchivosNominas" class="java.util.HashMap"> 
		  <result property="idNomina"                       column="cno_id"                          javaType="java.lang.Integer" />
		  <result property="nombreArchivo"                  column="arc_nombre"                      javaType="java.lang.String"  />
		  <result property="tipoArchivo"                    column="cod_id_tipo_archivo"             javaType="java.lang.String"  /> 
     </resultMap>    
	
	<procedure id="obtenerArchivosNomina" parameterMap="setObtenerArchivosNominas" resultMap="getArchivosNominas">
        { call sp_cns_archivo_nomina (?) }
    </procedure>
	
    <parameterMap id="setUpFileNominaGararantias" class="java.util.HashMap">
        <parameter property="cno_monto_nomina"              jdbcType="VARCHAR"     javaType="String"    />
        <parameter property="cpl_id"                        jdbcType="INTEGER"     javaType="Integer"   />
        <parameter property="cno_oficina"                   jdbcType="VARCHAR"     javaType="String"    />
        <parameter property="cno_canal"                     jdbcType="VARCHAR"     javaType="String"    />
        <parameter property="cno_destino_credito"           jdbcType="VARCHAR"     javaType="String"    />
        <parameter property="cno_ejecutivo"                 jdbcType="VARCHAR"     javaType="String"    />
        <parameter property="cno_glosa"                     jdbcType="VARCHAR"     javaType="String"    />
        <parameter property="cno_fecha_creacion"            jdbcType="VARCHAR"     javaType="Date"      />
        <parameter property="cno_tipo_operacion"            jdbcType="VARCHAR"     javaType="String"    />
        <parameter property="cno_oficio"                    jdbcType="VARCHAR"     javaType="String"    />
        <parameter property="arc_nombre"                    jdbcType="VARCHAR"     javaType="String"    />
        <parameter property="arc_tipo_archivo"              jdbcType="CHAR"        javaType="String"    />
        <parameter property="arc_contenido"                 jdbcType="Byte"      />
        <parameter property="cno_fecha_creacion"            jdbcType="VARCHAR"     javaType="Date"      />
        <parameter property="cod_id_estado"                 jdbcType="CHAR"        javaType="String"    />
        <parameter property="cno_fecha_creacion"            jdbcType="VARCHAR"     javaType="Date"      />
        <parameter property="cno_glosa"                     jdbcType="VARCHAR"     javaType="String"    />
    </parameterMap>

    <statement id="grabarArchivoNominaGarantia" parameterClass="java.util.HashMap" parameterMap="setUpFileNominaGararantias" resultClass="int">
        DECLARE @mensaje varchar(50), @newId int, @monto_nomina decimal(16,3), @cno_id int
        SELECT @monto_nomina = CONVERT( decimal(16,3), ? )
        SELECT @newId=MAX(cno_id)+1 from CABECERA_NOMINA
        SELECT @newId = ISNULL(@newId, 1)
        SELECT @cno_id = @newId
        BEGIN tran
            INSERT CABECERA_NOMINA (cpl_id,
                                    cno_id,
                                    cno_oficina,
                                    cno_canal,
                                    cno_destino_credito,
                                    cno_ejecutivo,
                                    cno_glosa,
                                    cno_fecha_creacion,
                                    cno_tipo_operacion,
                                    cno_monto_nomina,
                                    cno_oficio)
                            VALUES (?,@cno_id,?,?,?,?,?,?,?,@monto_nomina,?)
            IF NOT(@@error = 0)
            BEGIN
                ROLLBACK
                RAISERROR 30100 'Problema en insert de tabla CABECERA_NOMINA'
                RETURN
            END

            INSERT ARCHIVO_NOMINA(cno_id,
                                  arc_nombre,
                                  cod_id_tipo_archivo,
                                  arc_contenido,
                                  arc_fecha_carga)
                          VALUES (@cno_id,?,?,?,?)

            IF NOT(@@error = 0)
            BEGIN
                ROLLBACK tran
                RAISERROR 30101 'Problema en insert de tabla ARCHIVO_NOMINA'
                RETURN
            END

            INSERT INTO ESTADO_NOMINA(cno_id,
                                      cod_id_estado,
                                      eno_fecha_estado,
                                      eno_glosa,
                                      eno_estado)
                               VALUES(@cno_id,?,?,?,'S')
            IF NOT(@@error = 0)
            BEGIN
                ROLLBACK tran
                RAISERROR 30102 'Problema en insert de tabla ESTADO_NOMINA'
                RETURN
            END

            SELECT @cno_id

        COMMIT

    </statement>

    <resultMap id="responseMap" class="wcorp.aplicaciones.productos.colocaciones.cae.to.RespuestaBajarNominaTO">
          <result property="contenido" column="arc_contenido" jdbcType="Byte" javaType="[B" />
    </resultMap>

    <select  id="bajarArchivo" parameterMap="setDescargarArchivo" resultMap="responseMap">
           SELECT arc_contenido
           FROM ARCHIVO_NOMINA
           WHERE cno_id=? and cod_id_tipo_archivo=?
    </select>

    <parameterMap id="setAutorizarArchivo" class="java.util.HashMap">
       <parameter property="cno_id"                          jdbcType="INTEGER"       javaType="java.lang.Integer"/>
       <parameter property="cod_id_estado"                   jdbcType="CHAR"          javaType="java.lang.String" />
       <parameter property="eno_glosa"                       jdbcType="CHAR"          javaType="java.lang.String" />
    </parameterMap>

    <procedure id="autorizarArchivo"  parameterMap="setAutorizarArchivo" resultClass="int">
        { CALL sp_upd_estado_nomina(?,?,?) }
    </procedure>

</sqlMap>
