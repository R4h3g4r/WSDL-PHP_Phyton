<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE sqlMap      
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"      
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">
    
<sqlMap namespace="DocumentosCache.procedimientosAlmacenados">

 	<parameterMap id="setConsultaListaDocumentosCache" class="java.util.HashMap">
		<parameter property="rut" jdbcType="NUMERIC" javaType="long" />
		<parameter property="horas" jdbcType="NUMERIC" javaType="integer" />
	</parameterMap>

	<resultMap id="getConsultaListaDocumentosCache" class="java.util.HashMap">
		<result property="rut" column="rut_cli" javaType="long" />
		<result property="dv" column="rut_dv_cli" javaType="String" />
		<result property="numeroDocumento" column="num_doc" javaType="String" />
		<result property="tipoDocumento" column="doc_tipo" javaType="String" />
		<result property="monto" column="doc_monto" javaType="double" />
		<result property="fechaDocumento" column="doc_fecha" jdbcType="DATETIME" javaType="java.util.Date" />
		<result property="fechaIngresoDocumento" column="fecha_ing" jdbcType="DATETIME" javaType="java.util.Date" />
	</resultMap>
	
 	<procedure id="consultaListaDocumentosCache" parameterMap="setConsultaListaDocumentosCache" resultMap="getConsultaListaDocumentosCache">
		{ CALL sp_sel_lis_doc_cache(?,?) }
	</procedure>
	
	<parameterMap id="setConsultaDocumentoCache" class="java.util.HashMap">
		<parameter property="rut" jdbcType="NUMERIC" javaType="long" />
		<parameter property="numeroDocumento" jdbcType="VARCHAR" javaType="String" />
		<parameter property="horas" jdbcType="NUMERIC" javaType="integer" />
	</parameterMap>

	<resultMap id="getConsultaDocumentoCache" class="java.util.HashMap">
		<result property="rut" column="rut_cli" javaType="long" />
		<result property="dv" column="rut_dv_cli" javaType="String" />
		<result property="numeroDocumento" column="num_doc" javaType="String" />
		<result property="tipoDocumento" column="doc_tipo" javaType="String" />
		<result property="monto" column="doc_monto" javaType="double" />
		<result property="fechaDocumento" column="doc_fecha" jdbcType="DATETIME" javaType="java.util.Date" />
		<result property="fechaIngresoDocumento" column="fecha_ing" jdbcType="DATETIME" javaType="java.util.Date" />
		<result property="imagenDocumentoAnverso" column="doc_img_anv" javaType="String" />
		<result property="imagenDocumentoReverso" column="doc_img_rev" javaType="String" />
	</resultMap>
	
 	<statement id="consultaDocumentoCache" parameterMap="setConsultaDocumentoCache" resultMap="getConsultaDocumentoCache">
 		<![CDATA[
			SELECT rut_cli, 
				rut_dv_cli, 
				num_doc, 
				doc_tipo, 
				doc_monto, 
				doc_fecha, 
				fecha_ing, 
				doc_img_anv, 
				doc_img_rev 
			FROM doc_cache 
			WHERE rut_cli = ? and num_doc = ? and fecha_ing >= dateadd(hh, -(?), getdate())
		]]>
	</statement>
	
 	<statement id="insertaActualizaDocumentoCache" parameterClass="java.util.HashMap" resultClass="int">
 		<![CDATA[
 			IF EXISTS (SELECT 1 FROM doc_cache WHERE rut_cli=#rut# AND num_doc=#numeroDocumento#)
    			BEGIN
					UPDATE doc_cache 
					SET fecha_ing=getdate(), doc_img_anv=#imagenDocumentoAnverso#, doc_img_rev=#imagenDocumentoReverso#
					WHERE rut_cli=#rut# AND num_doc=#numeroDocumento# 
					SELECT @@ERROR as value
    			END
			ELSE
    			BEGIN
			INSERT INTO doc_cache 
				( rut_cli, 
					rut_dv_cli, 
					num_doc, 
					doc_tipo, 
					doc_monto, 
					doc_fecha, 
					fecha_ing, 
					doc_img_anv, 
					doc_img_rev ) 
			VALUES 
						( #rut#, #dv#, #numeroDocumento#, #tipoDocumento#, #monto#, #fechaDocumento#, getdate(), #imagenDocumentoAnverso#, #imagenDocumentoReverso# )
			SELECT @@ERROR as value
			    END
		]]>
	</statement>
</sqlMap>    
